library(tidyverse)
library(here)
library(readxl)
library(showtext)
library(khroma)
library(sf)
library(treemapify)
library(e1071)
font_add_google("Oleo Script", "Oleo Script")

# 1. Loading workflow example ---------------------------------------------
## step 1 -> load csv
CropMED_crops_admin <- read.csv(here("DataS1/CropMED_dataset.csv"),
                                sep = ",",
                                header = TRUE,
                                check.names = FALSE) |> 
  as_tibble()
CropMED_crops_admin <- CropMED_crops_admin |> 
  mutate(adm_level = str_replace(adm_level, " ", ""),
         adm_level = str_replace(adm_level, "  ", ""))


## step 2 -> convert text (wkt) geometries to simple feature geometry
CropMED_crops_admin_sf <- st_as_sf(CropMED_crops_admin, wkt = "geometry", crs = 4326) 

## step 3 -> plot an example for orange

CropMED_avocado_sf <- CropMED_crops_admin_sf |> 
  select(1:6, "avocado") |> 
  filter(avocado >0)

avocado_growing_regions <- ggplot()+
  geom_sf(data = CropMED_avocado_sf ,
          aes(geometry = geometry),
          fill = "olivedrab")

## step 4 -> improve visualization with masking ecoregions, projection and ggplot themes
### 4.1. read masking regions
blanking_ecoregions_sf <- sf::st_read(here("masking ecoregions/blanking_ecoregions_sf_wgs84_edited.shp"))
### 4.2. transform both sf's
CropMED_avocado_sf_3035 <- CropMED_avocado_sf |> 
  sf::st_transform(3035)
blanking_ecoregions_sf_3035 <- blanking_ecoregions_sf |> 
  sf::st_transform(3035)


### 4.3. obtain worldmap
world_sf <- rnaturalearth::ne_countries(scale = 10) |> 
  sf::st_transform(3035)

#### and crop it for our region!
bbox_avocado<- sf::st_bbox(CropMED_avocado_sf_3035)


### 4.4. improve plot by overlaying blanking regions, countries and some thematics

showtext_auto() # to use custom font

ggplot()+
  geom_sf(data = world_sf,
          color = "gray89",
          fill = "gray89")+
  geom_sf(data = CropMED_avocado_sf_3035,
          aes(fill = avocado))+
  geom_sf(data = blanking_ecoregions_sf_3035,
          aes(geometry = geometry),
          fill = "gray89",
          color = "gray89")+
  khroma::scale_fill_bamako()+
  theme_bw()+
  labs(fill = "Hectares with avocado",
       title = "Avocado growing regions")+
  theme(legend.position = "bottom",
        title = element_text(face = "bold"),
        plot.title = element_text(family = "Oleo Script", size = 25,
                                  colour = "gray32"),
        legend.text = element_text(margin = margin(t = 5,
                                                   r = 10, unit = "pt")),
        legend.key.width = unit(2, "cm"),
        legend.spacing.x = unit(0.5, "cm"))+
  coord_sf(xlim = c(bbox_avocado[1], bbox_avocado[3]),
           ylim = c(bbox_avocado[2], bbox_avocado[4]),
           expand = FALSE)



# 2. Pivoting data ---------------------------------------------
## 2.1. Prepare pivot ----
CropMED_crops_admin <- read.csv(here("DataS1/CropMED_dataset.csv"),
                                sep = ",",
                                header = TRUE,
                                check.names = FALSE)  |> 
  as_tibble()
CropMED_crops_admin_sf <- st_as_sf(CropMED_crops_admin, wkt = "geometry", crs = 4326) 

CropMED_sf_long <- CropMED_crops_admin_sf |> 
  pivot_longer(cols =-(1:6),
               names_to = "crop",
               values_to = "hectares")

## 2.2.  Add hierarchical crop groups ----
crop_hierarchy <- read_delim(here("DataS1/AnnexSup/CropMED_hierarchy.csv")) |>
  rename(crop = crop_name)

CropMED_sf_groups <- CropMED_sf_long |> 
  left_join(crop_hierarchy)
# this data set can be exported and used easily for analyses.

## 2.3. Nest pivoted data ----

CropMED_sf_nest <- CropMED_sf_groups |> 
  group_by(country_code, adm_id, adm_name, adm_level, adm_cat_local) |> 
  drop_na() |> 
  ungroup() |> 
  select(-geometry) |>
  as_tibble() |> 
  group_by(country_code, adm_id, adm_name, adm_level, adm_cat_local) |> 
  nest(crop_data = c(std_crop_group, std_crop_subgroup, crop, hectares)) |> 
  ungroup() |> 
  st_as_sf() 

# 3. data analysis ----

## 3.1. most represented crops ---------------------------------------------

CropMED_long <- CropMED_crops_admin |> #better work with tibble rather than sf 
  pivot_longer(cols =-(1:6),
               names_to = "crop",
               values_to = "hectares")


CropMED_groups <- CropMED_long |> 
  left_join(crop_hierarchy)

### now we can operate

CropMED_groups_props <- CropMED_groups |> 
  group_by(crop) |> 
  summarise(hectares = sum(hectares, na.rm = TRUE)) |> 
  mutate(prop_crop = hectares/sum(hectares, na.rm = TRUE))

## similar crops 

CropMED_std_crops <- CropMED_groups |> 
  ### first unify similar crops for visualization
  group_by(std_crop) |> 
  summarise(hectares = sum(hectares, na.rm = TRUE),
            std_crop_group,
            std_crop_subgroup) |> 
  slice(1) |> 
  ungroup() |> 
  mutate(perc_crop = 100*hectares/sum(hectares, na.rm = TRUE)) |> 
  arrange(desc(perc_crop)) |> 
  mutate(std_crop_group = as_factor(std_crop_group),
         hexcode_group = case_when(std_crop_group == "cereals" ~"#FDCB65",
                                   std_crop_group == "vegetables" ~"#28AD90",
                                   std_crop_group == "industrial crops" ~"#142C64",
                                   std_crop_group == "fruit orchards" ~"#EF6938",
                                   std_crop_group == "legumes" ~"#473335",
                                   std_crop_group == "ornamental plants and flowers" ~"#D52F5F",
                                   std_crop_group == "medicinal and aromatic plants and herbs" ~"#683F7A",
         )
  ) |> 
  drop_na()

# Create a named vector of colors
color_mapping <- CropMED_std_crops |> 
  distinct(std_crop_group, hexcode_group) |>  # Get unique group-color pairs
  deframe()  # Convert to named vector

#dev.new(width = 20, height = 15)
perc_crops_ranking <- ggplot(data = CropMED_std_crops)+
  geom_treemap(aes(area = perc_crop, fill = std_crop_group),
               color = "gray12" 
  ) +  # Use crop group for legend
  geom_treemap_text(aes(area = perc_crop, 
                        label = std_crop),
                    color = "white",
                    place = "center",
                    grow = TRUE) +
  scale_fill_manual(values = color_mapping)+
  labs(fill = "Crop group")+
  theme(legend.position = "bottom",
        legend.text = element_text(size = 180),
        legend.title = element_text(size = 200),
        legend.key.size = unit(6, "cm")
  )

print(perc_crops_ranking)
ggsave(plot = perc_crops_ranking,
       here("figures/perc_crops_ranking_zoom.png"),
       width = 32000,
       height = 16000,
       units = "px",
       dpi = 650,
       limitsize = FALSE)

perc_crops_ranking_tops <- perc_crops_ranking+
  labs(title = "Crop partitioning",
       subtitle = "CropMED",
       fill = "Crop group")+
  cowplot::theme_cowplot()+
  theme(legend.position = "bottom",               # Position legend at the bottom
        legend.title = element_text(size = 35, face = "bold"),  # Bold title
        legend.text = element_text(size = 30),     # Text size
        legend.key.size = unit(1, "cm"),         # Adjust size of the color boxes
        legend.spacing.x = unit(0.6, "cm"),       # Space between legend items
        title = element_text(size = 50)
  )
perc_crops_ranking_tops
ggsave(here("figures/perc_crops_ranking_tops.png"),
       width = 3000,
       height = 1500,
       units = "px",
       dpi = 300,
       limitsize = FALSE)


## 3.2. distinct admin units ---------------------------------------------
## different administrative units
length(unique(CropMED_groups$adm_id)) #1619

## different administrative units by level
CropMED_groups |> 
  group_by(adm_level, adm_id) |>
  slice(1) |> 
  ungroup(adm_id) |> 
  count()

## 3.3. areas diversity ---------------------------------------------
## different administrative units


CropMED_tbl_long <- CropMED_crops_admin |> 
  pivot_longer(cols =-(1:6),
               names_to = "crop",
               values_to = "hectares")

CropMED_hectares_admin <- CropMED_tbl_long |> 
  group_by(adm_id, adm_name, geometry) |> 
  summarise(cropped_ha = sum(hectares, na.rm = TRUE))

# CropMED_crops_admin_sf <- CropMED_hectares_admin |> 
#   sf::st_as_sf(wkt = "geometry", crs = 3035) |>
#   mutate(adm_ha = st_area(geometry))

## different administrative units by level
CropMED_groups |> 
  group_by(adm_level, adm_id) |>
  slice(1) |> 
  ungroup(adm_id) |> 
  count()

## different countries
CropMED_groups |> 
  distinct(country_code) |> 
  nrow() ## 49 different countries

CropMED_crops_areas <- CropMED_crops_admin_sf |> 
  select(1:6) |> 
  sf::st_transform(3035) |> 
  mutate(admin_unit_hectares = map_dbl(.x = geometry,
                                       .f = ~sf::st_area(.x))) |> 
  mutate(admin_unit_hectares = as.numeric(admin_unit_hectares) / 1e4) |> 
  mutate(adm_level = case_when(adm_level == "adm03 + adm03" ~ "adm03",
                               adm_level == "adm03 + adm03 + adm03" ~ "adm03",
                               adm_level == "adm03+adm03" ~ "adm03",
                               adm_level == "adm03+adm03+adm03" ~ "adm03",
                               .default = adm_level))

CropMED_crops_areas_adm03 <- CropMED_crops_areas |> 
  filter(str_detect(adm_level, "adm03"))

summary(CropMED_crops_areas_adm03$admin_unit_hectares)

distribution_areas_adm_units <- ggplot(data = CropMED_crops_areas,
                                       aes(x = admin_unit_hectares))+
  geom_boxplot(aes(fill = adm_level))+
  theme_bw()+
  khroma::scale_fill_acton(discrete = TRUE, reverse = TRUE)+
  theme(axis.text.y = element_blank())+
  labs(x = "Hectares",
       fill = "Administrative Level")+
  coord_cartesian(xlim = c(0, quantile(CropMED_crops_areas$admin_unit_hectares, 0.99))) +  # Adjust to show 99% of the data
  theme_minimal(base_size = 45)

distribution_areas_adm_units
ggsave(filename = here("figures/adm_level_boxplots.png"),
       width = 12, height = 6, dpi = 300)



# 4. Mapping crop partitioning ----


map_crop_distribution <- function(background_land,
                                  CropMED_crops_vert,
                                  remove_regions,
                                  crop_std_name,
                                  grouping_level,
                                  my_crs,
                                  use_custom_font = FALSE) {
  if(use_custom_font) {
    showtext_auto() # to use custom font
  }
  
  if (grouping_level == "crop") {
    CropMED_crops_i <- CropMED_crops_vert |> 
      filter(std_crop == crop_std_name) |> 
      group_by(adm_id) |> 
      mutate(hectares = sum(hectares, na.rm = TRUE)) |> 
      slice(1) |> 
      filter(hectares > 0)
    
  } else if (grouping_level == "subgroup") {
    CropMED_crops_i <- CropMED_crops_vert |> 
      filter(std_crop_subgroup == crop_std_name) |> 
      group_by(adm_id) |> 
      mutate(hectares = sum(hectares, na.rm = TRUE)) |> 
      slice(1) |> 
      filter(hectares > 0)
    
  } else {
    CropMED_crops_i <- CropMED_crops_vert |> 
      filter(std_crop_group == crop_std_name) |> 
      group_by(adm_id) |> 
      mutate(hectares = sum(hectares, na.rm = TRUE)) |> 
      slice(1) |> 
      filter(hectares > 0)
  }
  
  CropMED_crops_admin_sf <- st_as_sf(CropMED_crops_i, 
                                     wkt = "geometry", 
                                     crs = 4326) 
  if(my_crs == 4326) {
    CropMED_crops_admin_sf
  } else {
    CropMED_crops_admin_sf <- st_transform(CropMED_crops_admin_sf, my_crs)
  }
  
  bbox_crop <- sf::st_bbox(CropMED_crops_admin_sf)
  
  cropmap_i <- ggplot()+
    geom_sf(data = background_land,
            color = "gray89",
            fill = "gray89")+
    geom_sf(data = CropMED_crops_admin_sf,
            aes(fill = hectares),
            color = "gray64", linewidth = .2)+
    geom_sf(data = remove_regions,
            aes(geometry = geometry),
            fill = "gray89",
            color = "gray89")+
    khroma::scale_fill_YlOrBr()+
    theme_bw()+
    labs(fill = paste("Hectares with", crop_std_name),
         title = paste(str_to_title(crop_std_name, "growing regions")))+
    theme(legend.position = "bottom",
          title = element_text(face = "bold"),
          plot.title = element_text(family = "Oleo Script", size = 60,
                                    colour = "gray32"),
          text = element_text(size = 50),   
          legend.text = element_text(size = 40),
          legend.title = element_text(size = 40),
          axis.text = element_text(size = 30),  
          axis.title = element_text(size = 55),
          legend.key.size = unit(1.5, "cm"))+  
    coord_sf(xlim = c(bbox_crop[1], bbox_crop[3]),
             ylim = c(bbox_crop[2], bbox_crop[4]),
             expand = FALSE)
  return(cropmap_i)
}


## 4.1. Map individual crops ----------------------------------------------------
crops_indiv <- unique(CropMED_groups$std_crop)

for(crop_i in crops_indiv) {
  print(paste0(which(crops_indiv == crop_i), "/", length(crops_indiv)))
  map_crop_i <- map_crop_distribution(background_land = world_sf,
                                      CropMED_crops_vert = CropMED_groups,
                                      remove_regions = blanking_ecoregions_sf_3035,
                                      crop_std_name = crop_i,
                                      grouping_level = "crop",
                                      my_crs = 3035,
                                      use_custom_font = TRUE)
  ggsave(here(paste0("figures/crop_indiv_maps/", crop_i, ".png")),
         height = 25,
         width = 32,
         units = "cm", 
         dpi = 320
  )
}

## 4.2. Map crop subgroups ----------------------------------------------------
crops_subgroups <- unique(CropMED_groups$std_crop_subgroup)

for(crop_i in crops_subgroups) {
  print(paste0(which(crops_subgroups == crop_i), "/", length(crops_subgroups)))
  map_crop_i <- map_crop_distribution(background_land = world_sf,
                                      CropMED_crops_vert = CropMED_groups,
                                      remove_regions = blanking_ecoregions_sf_3035,
                                      crop_std_name = crop_i,
                                      grouping_level = "subgroup",
                                      my_crs = 3035,
                                      use_custom_font = TRUE)
  ggsave(here(paste0("figures/crop_subgroups_maps/", crop_i, ".png")),
         height = 25,
         width = 32,
         units = "cm", 
         dpi = 320
  )
}

## 4.3. Map crop subgroups ----------------------------------------------------
crops_groups <- unique(CropMED_groups$std_crop_group)

for(crop_i in crops_groups) {
  print(paste0(which(crops_groups == crop_i), "/", length(crops_groups)))
  map_crop_i <- map_crop_distribution(background_land = world_sf,
                                      CropMED_crops_vert = CropMED_groups,
                                      remove_regions = blanking_ecoregions_sf_3035,
                                      crop_std_name = crop_i,
                                      grouping_level = "group",
                                      my_crs = 3035,
                                      use_custom_font = TRUE)
  ggsave(here(paste0("figures/crop_groups_maps/", crop_i, ".png")),
         height = 25,
         width = 32,
         units = "cm", 
         dpi = 320
  )
}



# 5. climate data ------------------------------------------------------------

## create a mask
cropMED_provinces <- CropMED_crops_admin_sf |> 
  select(adm_id, geometry) |> 
  st_union()

## get geodata 

tmin_geodata <- geodata::worldclim_global(var = "tmin",
                                          res = 2.5,
                                          path = tempdir())
tmax_geodata <- geodata::worldclim_global(var = "tmax",
                                          res = 2.5,
                                          path = tempdir())
prec_geodata <- geodata::worldclim_global(var = "prec",
                                          res = 2.5,
                                          path = tempdir())
tavg_geodata <- geodata::worldclim_global(var = "tavg",
                                          res = 2.5,
                                          path = tempdir())
vapor_geodata <- geodata::worldclim_global(var = "vapr",
                                           res = 2.5,
                                           path = tempdir())
solar_geodata <- geodata::worldclim_global(var = "srad",
                                           res = 2.5,
                                           path = tempdir())


# mask
batlow_palette <- khroma::colour("batlow")

map_clim <- function(cropmed_sf,
                     clim_rast,
                     my_crs = 4326,
                     clim_var_name,
                     clim_var_units,
                     world_background) {
  
  clim_cropmed <- terra::mask(clim_rast,
                              CropMED_crops_admin_sf)
  clim_cropmed_epsg <- terra::project(clim_cropmed,
                                      paste0("EPSG:", my_crs))
  cropmed_sf_epsg <- sf::st_transform(cropmed_sf,
                                      my_crs)
  clim_cropmed_fix <- terra::crop(clim_cropmed_epsg,
                                  cropmed_sf_epsg)
  bbox_cropmed <- st_bbox(cropmed_sf_epsg)
  
  bioclim_plot <- ggplot()+
    geom_sf(data = world_background,
            fill = "gray85",
            color = "gray85")+
    tidyterra::geom_spatraster(data = clim_cropmed_fix,
                               maxcell = Inf)+
    lims(x = c(bbox_cropmed[1], bbox_cropmed[3]),
         y = c(bbox_cropmed[2], bbox_cropmed[4]))+
    scale_fill_gradientn(colours = batlow_palette(n = 10),
                         na.value = "transparent")+
    theme_bw()+
    labs(title = clim_var_name,
         fill = clim_var_units)+
    theme(
      text = element_text(size = 36),    # Increases all text elements
      axis.text = element_text(size = 36), 
      axis.title = element_text(size = 44),
      legend.text = element_text(size = 36), 
      legend.title = element_text(size = 46),
      plot.title = element_text(size = 60, face = "bold")
    )
  return(bioclim_plot)
}

## a) Bioclimatic -------------------------------------------------------------

BIO_names <- tibble(varname = c("Annual Mean Temperature",
                                "Mean Diurnal Range",
                                "Isothermality",
                                "Temperature Seasonality",
                                "Max Temperature of Warmest Month",
                                "Min Temperature of Coldest Month",
                                "Temperature Annual Range",
                                "Mean Temperature of Wettest Quarter",
                                "Mean Temperature of Driest Quarter",
                                "Mean Temperature of Warmest Quarter",
                                "Mean Temperature of Coldest Quarter",
                                "Annual Precipitation",
                                "Precipitation of Wettest Month",
                                "Precipitation of Driest Month",
                                "Precipitation Seasonality",
                                "Precipitation of Wettest Quarter",
                                "Precipitation of Driest Quarter",
                                "Precipitation of Warmest Quarter",
                                "Precipitation of Coldest Quarter"),
                    units = c("Temperature (ºC)",
                              "Temperature (ºC)",
                              "Ratio",
                              "SD Temperature × 100",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Temperature (ºC)",
                              "Precipitation (mm)",
                              "Precipitation (mm)",
                              "Precipitation (mm)",
                              "Coefficient of Variation",
                              "Precipitation (mm)",
                              "Precipitation (mm)",
                              "Precipitation (mm)",
                              "Precipitation (mm)"))


bio_geodata <- geodata::worldclim_global(var = "bio",
                                         res = 2.5,
                                         path = tempdir())
for(i in 1:19) {
  bioclim_rast_i <- bio_geodata[[i]]
  BIO_names_i <- BIO_names[i,]
  var_name_i <- paste0("BIO", i, ": ", BIO_names_i$varname)
  var_units_i <- BIO_names_i$units
  
  ggplot_bioclim_i <- map_clim(cropmed_sf = CropMED_crops_admin_sf,
                               clim_rast = bioclim_rast_i,
                               my_crs = 3035,
                               clim_var_name = var_name_i,
                               clim_var_units = var_units_i,
                               world_background = world_sf)
  
  ggsave(plot = ggplot_bioclim_i,
         filename = here(paste0("figures/BIOCLIM/", "BIO", i, "_CropMED.png")),
         width = 10,               
         height = 7,               
         dpi = 300,                
         units = "in",             
         bg = "white")
  
}

## summaries
bioclim_cropmed <- terra::mask(bio_geodata, 
                               CropMED_crops_admin_sf)

bioclim_cropmed_summaries <- tibble()

set.seed(2025)
for(i in 1:19) {
  print(i)
  bioclim_cropmed_BIO_i<- bioclim_cropmed[[i]]
  values_i <- terra::values(bioclim_cropmed_BIO_i)
  sumstats_i <- tibble(
    mean = mean(values_i, na.rm = TRUE),
    sd = sd(values_i, na.rm = TRUE),
    min = min(values_i, na.rm = TRUE),
    max = max(values_i, na.rm = TRUE),
    q25 = quantile(values_i, probs = .25, na.rm = TRUE),
    q75 = quantile(values_i, probs = .75, na.rm = TRUE),
    median = median(values_i, na.rm = TRUE),
    kurtosis = e1071::kurtosis(values_i, na.rm = TRUE),
    skewness = e1071::skewness(values_i, na.rm = TRUE)
  ) |> 
    mutate(var_name = paste0("BIO", i))
  bioclim_cropmed_summaries <- bind_rows(bioclim_cropmed_summaries, sumstats_i)
}

bioclim_cropmed_summaries

days_per_month <- c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31)
solar_total <- sum(solar_geodata * days_per_month)

map_clim(cropmed_sf = CropMED_crops_admin_sf,
         clim_rast = solar_geodata_annual,
         my_crs = 3035,
         clim_var_name = "Annual Solar Radiation received",
         clim_var_units = expression("kJ m"^"-2" * " year"^"-1"),
         world_background = world_sf)+
  theme(text = element_text(size = 16),    # Increases all text elements
        axis.text = element_text(size = 16), 
        axis.title = element_text(size = 24),
        legend.text = element_text(size = 16), 
        legend.title = element_text(size = 26),
        plot.title = element_text(size = 40, face = "bold"))

ggsave(filename = here("figures/BIOCLIM/solar_radiation.png"),
       width = 20,               
       height = 14,               
       dpi = 300,                
       units = "in",             
       bg = "white")



bbox_latlon <- sf::st_bbox(CropMED_crops_admin_sf)
